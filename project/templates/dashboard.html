<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
</head>

<body>

<h1>Welcome to dashboard</h1>
<h2>Code: {{ code }}</h2>

<div id="sessionContainer">

{% for i in sessions %}
<div id="session-{{ i.id }}">
    <p>{{ i.student_name }}</p>
    <video id="video-{{ i.id }}"
           autoplay playsinline muted width="300"></video>

    <button onclick="endSession({{ i.id }})">
        End Session
    </button>
</div>
{% endfor %}

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

/* ---------------------------
   End session manually
----------------------------*/
window.endSession = function(id) {
    fetch(`/end-session/${id}/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}"
        }
    });
};


/* ---------------------------
   WebSocket connection
----------------------------*/
const protocol =
    window.location.protocol === "https:" ? "wss://" : "ws://";

const socket = new WebSocket(
    protocol + window.location.host +
    "/ws/session/{{ request.user.id }}/"
);

socket.onopen = () => console.log("WebSocket Connected");
socket.onerror = e => console.log("Socket error", e);


/* ---------------------------
   Peer map
----------------------------*/
const peers = {};


/* ---------------------------
   Signaling handler
----------------------------*/
socket.onmessage = async e => {
    const data = JSON.parse(e.data);

    const sessionId = data.session_id;
    if (!sessionId) return;

    /* Create peer if not exists */
    if (!peers[sessionId]) {
        console.log("Creating peer:", sessionId);

        const pc = new RTCPeerConnection();

        /* Detect disconnect */
        pc.onconnectionstatechange = () => {
            console.log(
                "Connection state:",
                pc.connectionState,
                sessionId
            );

            if (
                pc.connectionState === "disconnected" ||
                pc.connectionState === "failed" ||
                pc.connectionState === "closed"
            ) {
                console.log("Removing session:", sessionId);

                const box = document.getElementById(
                    `session-${sessionId}`
                );

                if (box) box.remove();

                pc.close();
                delete peers[sessionId];
            }
        };

        /* ICE candidates */
        pc.onicecandidate = event => {
            if (event.candidate) {
                socket.send(JSON.stringify({
                    type: "candidate",
                    candidate: event.candidate,
                    session_id: sessionId
                }));
            }
        };

        /* Receive video */
        pc.ontrack = async event => {
            console.log("Stream received:", sessionId);

            let video =
                document.getElementById(`video-${sessionId}`);

            /* Create UI if not present */
            if (!video) {
                const container =
                    document.getElementById("sessionContainer");

                const box = document.createElement("div");
                box.id = `session-${sessionId}`;

                box.innerHTML = `
                    <p>Student ${sessionId}</p>
                    <video id="video-${sessionId}"
                           autoplay playsinline muted
                           width="300"></video>
                `;

                container.appendChild(box);
                video = box.querySelector("video");
            }

            video.srcObject = event.streams[0];

            try {
                await video.play();
            } catch (err) {
                console.log("Play blocked:", err);
            }
        };

        peers[sessionId] = pc;
    }

    const pc = peers[sessionId];

    /* Offer */
    if (data.type === "offer") {
        await pc.setRemoteDescription(
            new RTCSessionDescription(data.offer)
        );

        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        socket.send(JSON.stringify({
            type: "answer",
            answer,
            session_id: sessionId
        }));
    }

    /* ICE candidates */
    if (data.type === "candidate") {
        if (pc.remoteDescription) {
            await pc.addIceCandidate(
                new RTCIceCandidate(data.candidate)
            );
        }
    }
};

});
</script>

</body>
</html>
