<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Screen Share Session</title>
</head>

<body>

<h2>Student Screen Sharing</h2>

<button id="shareBtn">Share Screen</button>
<br><br>

<video id="preview" autoplay playsinline muted width="600"></video>

<script>
let stream = null;
let peerConnection = null;
let pendingCandidates = [];

/* -------------------------
   WebSocket connection
--------------------------*/
const protocol =
    window.location.protocol === "https:" ? "wss://" : "ws://";

const socket = new WebSocket(
    protocol + window.location.host +
    "/ws/session/{{ admin_id }}/"
);

socket.onopen = () => console.log("Student socket connected");
socket.onerror = e => console.log("Socket error:", e);


/* -------------------------
   Handle signaling
--------------------------*/
socket.onmessage = async e => {
    const data = JSON.parse(e.data);

    // if (!peerConnection) return;

    if (data.type === "answer") {
        console.log("Answer received");

        await peerConnection.setRemoteDescription(
            new RTCSessionDescription(data.answer)
        );

        for (const c of pendingCandidates) {
            await peerConnection.addIceCandidate(c);
        }

        pendingCandidates = [];
    }

    if (data.type === "candidate") {
        const candidate =
            new RTCIceCandidate(data.candidate);

        if (peerConnection.remoteDescription) {
            await peerConnection.addIceCandidate(candidate);
        } else {
            pendingCandidates.push(candidate);
        }
    }
};


/* -------------------------
   End session helper
--------------------------*/
function endSession() {
    console.log("Ending session");

    fetch("/end-session/{{ session.id }}/", {
        method: "POST"
    });

    if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
    }

    if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
    }
}


/* -------------------------
   Screen Share Button
--------------------------*/
document.getElementById("shareBtn").onclick =
async () => {
    try {
        stream =
            await navigator.mediaDevices.getDisplayMedia({
                video: true,
                audio: false
            });

        const video =
            document.getElementById("preview");

        video.srcObject = stream;
        await video.play();

        console.log("Screen sharing started");

        peerConnection = new RTCPeerConnection();

        /* Send ICE candidates */
        peerConnection.onicecandidate = event => {
            if (event.candidate) {
                socket.send(JSON.stringify({
                    type: "candidate",
                    candidate: event.candidate,
                    session_id: "{{ session.id }}"
                }));
            }
        };

        /* Add tracks */
        stream.getTracks().forEach(track => {
            peerConnection.addTrack(track, stream);
        });

        /* Detect stop sharing */
        stream.getVideoTracks()[0].onended =
            endSession;

        console.log("Creating offer");

        const offer =
            await peerConnection.createOffer();

        await peerConnection
            .setLocalDescription(offer);

        console.log("Sending offer");

        socket.send(JSON.stringify({
            type: "offer",
            offer: offer,
            session_id: "{{ session.id }}"
        }));

    } catch (err) {
        console.log("User cancelled sharing");
    }
};


/* -------------------------
   Tab close cleanup
--------------------------*/
window.addEventListener(
    "beforeunload",
    endSession
);
</script>

</body>
</html>
